<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
</head>
<body>
    <h1>Dashboard</h1>

    <h3>Add Customer</h3>
    <form id="addCustomerForm">
        <input type="email" id="customerEmail" placeholder="Enter customer email" required>
        <button type="submit">Add</button>
    </form>

    <p id="responseMessage"></p>

    <h3>All Users and Customers</h3>
    <div id="usersContainer"></div>

    <script>
        async function loadUsers() {
            const res = await fetch("/user-customer");
            const data = await res.json();

            const container = document.getElementById("usersContainer");
            container.innerHTML = "";

            data.forEach(user => {
                const userDiv = document.createElement("div");
                userDiv.style.border = "1px solid #ccc";
                userDiv.style.margin = "10px 0";
                userDiv.style.padding = "10px";

                const userInfo = document.createElement("h4");
                userInfo.textContent = `${user.company_name} (${user.email})`;
                userDiv.appendChild(userInfo);

                if (user.customers.length === 0) {
                    const noCust = document.createElement("p");
                    noCust.textContent = "No customers yet.";
                    userDiv.appendChild(noCust);
                } else {
                    const list = document.createElement("ul");

                    user.customers.forEach(c => {
                        const item = document.createElement("li");
                        item.textContent = `${c.email} - ${c.points} pts `;

                        const sendBtn = document.createElement("button");
                        sendBtn.textContent = "Send Email";
                        sendBtn.style.marginLeft = "10px";

                        sendBtn.addEventListener("click", async () => {
                            const res = await fetch("/send-test-email", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ customer_email: c.email })
                            });

                            if (res.ok) {
                                alert(`✅ Email sent to ${c.email}`);
                            } else {
                                const err = await res.json();
                                alert(`❌ Failed to send: ${err.error || "Unknown error"}`);
                            }
                        });

                        item.appendChild(sendBtn);
                        list.appendChild(item);
                    });

                    userDiv.appendChild(list);
                }

                container.appendChild(userDiv);
            });
        }

        // Load users on page load
        loadUsers();

        // Add customer form
        document.getElementById("addCustomerForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const email = document.getElementById("customerEmail").value;

            const res = await fetch("/add-customer", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ email })
            });

            const data = await res.json();
            const msg = document.getElementById("responseMessage");

            if (res.ok) {
                msg.textContent = `✅ Added customer: ${data.email}`;
                msg.style.color = "green";
                loadUsers(); // refresh
            } else {
                msg.textContent = `❌ ${data.error}`;
                msg.style.color = "red";
            }
        });
    </script>
</body>
</html>
